<?php
/**
 *
 *  GCPEDIA ROT Edit count extension
 *
 */

$wgHooks['ParserBeforeInternalParse'][] = 'rot';

function rot( &$parser, &$text, &$strip_state )
{
	global $wgTitle;
	
	$dbr = wfGetDB( DB_SLAVE );
	$queryString = "CREATE TABLE IF NOT EXISTS rotusers (user_name varchar(100), start_editcount varchar(10))	";
	$result = $dbr->query($queryString);
	
	if ( substr( $wgTitle, 0, 5 ) == "User:" ){
		
		getROTCount( getUName( substr( $wgTitle, 5, strlen($wgTitle) ) ), $text );
		
	}
	else if ( substr( $wgTitle, 0, 10 ) == "User talk:" ){
		
		getROTCount( getUName( substr( $wgTitle, 10, strlen($wgTitle) ) ), $text );
		
	}
	

	return true;


}

function getROTCount( $username, &$text )
{
	$user =  User::newFromName( $username );
	$total = $user->getEditCount();
	
	$dbr = wfGetDB( DB_SLAVE );
	$queryString = "SELECT * FROM `rotusers` WHERE `user_name` = '".$username ."'";
	$result = $dbr->query($queryString);
	$row = $dbr->fetchRow($result);
	
	if ( $row[0] != $username ){	// user not in rot db
	
		str_replace( "<ROTedits>", "<ROTedits>", $text, $countreplace );		// only for the count
		str_replace( "<ROTparticipant>", "<ROTparticipant>", $text, $countreplace2 );
		if ( $countreplace + $countreplace2 > 0 ) {
			$queryString2 = "INSERT INTO `rotusers` (user_name, start_editcount) VALUES ( '".$username ."', " . $total . ")";
			$dbr->query($queryString2);
			$result = $dbr->query($queryString);
		}
	}
	
	$rotstart = $row[1];
	
	$rotcount = $total - $rotstart;
	$text = str_replace( "<ROTedits>", $rotcount, $text );
	$text = str_replace( "<ROTparticipant>", "", $text );
	
}


/**
 * Uses the title of the page (excluding namespace) to return the username of the user who's awards should be displayed
 */
/*function getUName( $pagename )
{
	$name = $pagename;
	$pos;
	
	$pos = strripos( $pagename, "/" );
	
	if ( $pos )
		$name = substr( $pagename, 0, $pos );
	
	
	return $name;
}*/

?>